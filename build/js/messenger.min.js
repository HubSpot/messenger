/*! messenger 1.0.10 2013-03-04 */
(function(){var e,s,t,n,r,o,i={}.hasOwnProperty,a=function(e,s){function t(){this.constructor=e}for(var n in s)i.call(s,n)&&(e[n]=s[n]);return t.prototype=s.prototype,e.prototype=new t,e.__super__=s.prototype,e},l=[].slice,u=[].indexOf||function(e){for(var s=0,t=this.length;t>s;s++)if(s in this&&this[s]===e)return s;return-1};e=jQuery,o='<div class="messenger-spinner">\n    <span class="messenger-spinner-side messenger-spinner-side-left">\n        <span class="messenger-spinner-fill"></span>\n    </span>\n    <span class="messenger-spinner-side messenger-spinner-side-right">\n        <span class="messenger-spinner-fill"></span>\n    </span>\n</div>',n=function(s){function t(){return t.__super__.constructor.apply(this,arguments)}return a(t,s),t.prototype.defaults={hideAfter:10,scroll:!0},t.prototype.initialize=function(s){return null==s&&(s={}),this.shown=!1,this.rendered=!1,this.messenger=s.messenger,this.options=e.extend({},this.options,s,this.defaults)},t.prototype.show=function(){var e;return this.render(),this.$message.removeClass("messenger-hidden"),e=this.shown,this.shown=!0,e?void 0:this.trigger("show")},t.prototype.hide=function(){var e;if(this.rendered)return this.$message.addClass("messenger-hidden"),e=this.shown,this.shown=!1,e?this.trigger("hide"):void 0},t.prototype.cancel=function(){return this.hide()},t.prototype.update=function(s){var t,n=this;return e.extend(this.options,s),this.lastUpdate=new Date,this.rendered=!1,this.events=null!=(t=this.options.events)?t:{},this.render(),this.actionsToEvents(),this.delegateEvents(),this.checkClickable(),this.options.hideAfter?(this.$message.addClass("messenger-will-hide-after"),null!=this._hideTimeout&&clearTimeout(this._hideTimeout),this._hideTimeout=setTimeout(function(){return n.hide()},1e3*this.options.hideAfter)):this.$message.removeClass("messenger-will-hide-after"),this.options.hideOnNavigate?(this.$message.addClass("messenger-will-hide-on-navigate"),null!=Backbone.history&&Backbone.history.on("route",function(){return n.hide()})):this.$message.removeClass("messenger-will-hide-on-navigate"),this.trigger("update",this)},t.prototype.scrollTo=function(){return this.options.scroll?e.scrollTo(this.$el,{duration:400,offset:{left:0,top:-20}}):void 0},t.prototype.timeSinceUpdate=function(){return this.lastUpdate?new Date-this.lastUpdate:null},t.prototype.actionsToEvents=function(){var e,s,t,n;t=this.options.actions,n=[];for(s in t)e=t[s],n.push(this.events['click [data-action="'+s+'"] a']=function(e){return function(s){return s.preventDefault(),s.stopPropagation(),e.action(s)}}(e));return n},t.prototype.checkClickable=function(){var e,s,t,n;t=this.events,n=[];for(s in t)e=t[s],"click"===s?n.push(this.$message.addClass("messenger-clickable")):n.push(void 0);return n},t.prototype.undelegateEvents=function(){var e;return t.__super__.undelegateEvents.apply(this,arguments),null!=(e=this.$message)?e.removeClass("messenger-clickable"):void 0},t.prototype.parseActions=function(){var s,t,n,r,o,i;t=[],o=this.options.actions;for(r in o)s=o[r],n=e.extend({},s),n.name=r,null==(i=n.label)&&(n.label=r),t.push(n);return t},t.prototype.template=function(s){var t,n,r,i,a,l,u,h,c,p,d=this;for(a=e("<div class='messenger-message message alert "+s.type+" message-"+s.type+" alert-"+s.type+"'>"),s.showCloseButton&&(r=e('<button type="button" class="close" data-dismiss="alert">&times;</button>'),r.click(function(){return d.cancel(),!0}),a.append(r)),l=e('<div class="messenger-message-inner">'+s.message+"</div>"),a.append(l),a.append(e(o)),s.actions.length&&(n=e('<div class="messenger-actions">')),p=s.actions,h=0,c=p.length;c>h;h++)u=p[h],t=e("<span>"),t.attr("data-action",""+u.name),i=e("<a>"),i.html(u.label),t.append(e('<span class="messenger-phrase">')),t.append(i),n.append(t);return a.append(n),a},t.prototype.render=function(){var s;if(!this.rendered)return this._hasSlot||(this.setElement(this.messenger._reserveMessageSlot(this)),this._hasSlot=!0),s=e.extend({},this.options,{actions:this.parseActions()}),this.$message=e(this.template(s)),this.$el.html(this.$message),this.shown=!0,this.rendered=!0,this.trigger("render")},t}(Backbone.View),t=function(e){function s(){return s.__super__.constructor.apply(this,arguments)}return a(s,e),s.prototype.initialize=function(){return s.__super__.initialize.apply(this,arguments),this._timers={}},s.prototype.cancel=function(){return this.clearTimers(),this.hide(),null!=this._actionInstance&&null!=this._actionInstance.abort?this._actionInstance.abort():void 0},s.prototype.clearTimers=function(){var e,s,t,n;t=this._timers;for(e in t)s=t[e],clearTimeout(s);return null!=(n=this.$message)?n.removeClass("messenger-retry-soon messenger-retry-later"):void 0},s.prototype.render=function(){var e,t,n,r;s.__super__.render.apply(this,arguments),this.clearTimers(),n=this.options.actions,r=[];for(t in n)e=n[t],e.auto?r.push(this.startCountdown(t,e)):r.push(void 0);return r},s.prototype.renderPhrase=function(e,s){var t;return t=e.phrase.replace("TIME",this.formatTime(s))},s.prototype.formatTime=function(e){var s;return s=function(e,s){return e=Math.floor(e),1!==e&&(s+="s"),"in "+e+" "+s},0===Math.floor(e)?"now...":60>e?s(e,"second"):(e/=60,60>e?s(e,"minute"):(e/=60,s(e,"hour")))},s.prototype.startCountdown=function(e,s){var t,n,r,o,i=this;return t=this.$message.find("[data-action='"+e+"'] .messenger-phrase"),n=null!=(o=s.delay)?o:3,10>=n?(this.$message.removeClass("messenger-retry-later"),this.$message.addClass("messenger-retry-soon")):(this.$message.removeClass("messenger-retry-soon"),this.$message.addClass("messenger-retry-later")),r=function(){return n-=1,t.text(i.renderPhrase(s,n)),n>0?i._timers[e]=setTimeout(r,1e3):(i.$message.removeClass("messenger-retry-soon messenger-retry-later"),delete i._timers[e],s.action())},r()},s}(n),r=function(s){function n(){return n.__super__.constructor.apply(this,arguments)}return a(n,s),n.prototype.tagName="ul",n.prototype.className="messenger",n.prototype.messageDefaults={type:"info"},n.prototype.initialize=function(s){return this.options=null!=s?s:{},this.history=[],this.messageDefaults=e.extend({},this.messageDefaults,this.options.messageDefaults)},n.prototype.render=function(){return this.updateMessageSlotClasses()},n.prototype.findById=function(e){return _.filter(this.history,function(s){return s.msg.options.id===e})},n.prototype._reserveMessageSlot=function(s){var t,n,r=this;for(t=e("<li>"),t.addClass("messenger-message-slot"),this.$el.prepend(t),this.history.push({msg:s,$slot:t}),this._enforceIdConstraint(s),s.on("update",function(){return r._enforceIdConstraint(s)});this.options.maxMessages&&this.history.length>this.options.maxMessages;)n=this.history.shift(),n.msg.remove(),n.$slot.remove();return t},n.prototype._enforceIdConstraint=function(e){var s,t,n,r,o;if(null!=e.options.id)for(o=this.history,t=0,n=o.length;n>t;t++)if(s=o[t],r=s.msg,null!=r.options.id&&r.options.id===e.options.id&&e!==r){if(e.options.singleton)return e.hide(),void 0;r.hide()}},n.prototype.newMessage=function(e){var s,n=this;return null==e&&(e={}),e.messenger=this,s=new t(e),s.on("show",function(){return e.scrollTo&&"fixed"!==n.$el.css("position")?s.scrollTo():void 0}),s.on("hide show render",this.updateMessageSlotClasses,this),s},n.prototype.updateMessageSlotClasses=function(){var e,s,t,n,r,o,i;for(n=!0,s=null,e=!1,i=this.history,r=0,o=i.length;o>r;r++)t=i[r],t.$slot.removeClass("first last shown"),t.msg.shown&&t.msg.rendered&&(t.$slot.addClass("shown"),e=!0,s=t,n&&(n=!1,t.$slot.addClass("first")));return null!=s&&s.$slot.addClass("last"),this.$el[""+(e?"remove":"add")+"Class"]("messenger-empty")},n.prototype.hideAll=function(){var e,s,t,n,r;for(n=this.history,r=[],s=0,t=n.length;t>s;s++)e=n[s],r.push(e.msg.hide());return r},n.prototype.post=function(s){var t;return _.isString(s)&&(s={message:s}),s=e.extend(!0,{},this.messageDefaults,s),t=this.newMessage(s),t.update(s),t},n}(Backbone.View),s=function(s){function t(){return t.__super__.constructor.apply(this,arguments)}return a(t,s),t.prototype.doDefaults={progressMessage:null,successMessage:null,errorMessage:"Error connecting to the server.",showSuccessWithoutError:!0,retry:{auto:!0,allow:!0},action:e.ajax},t.prototype.hookBackboneAjax=function(s){var t,n,r=this;return null==s&&(s={}),s=_.defaults(s,{id:"BACKBONE_ACTION",errorMessage:!1,successMessage:"Request completed successfully.",showSuccessWithoutError:!1}),t=function(t){return e("html").hasClass("ie9-and-less")&&(t.cache=!1),r["do"](s,t)},null!=Backbone.ajax?Backbone.ajax=t:(n=Backbone.sync,Backbone.sync=function(r,o,i){var a;return a=e.ajax,e.ajax=t,null!=i.messenger&&_.extend(s,i.messenger),n.call(Backbone,r,o,i),e.ajax=a})},t.prototype._getMessage=function(e,s){return e===!1?!1:e===!0||null==e||"string"!=typeof e?s:e},t.prototype._parseEvents=function(e){var s,t,n,r,o,i,a;null==e&&(e={}),o={};for(r in e)n=e[r],t=r.indexOf(" "),i=r.substring(0,t),s=r.substring(t+1),null==(a=o[i])&&(o[i]={}),o[i][s]=n;return o},t.prototype._normalizeResponse=function(){var e,s,t,n,r,o,i;for(t=arguments.length>=1?l.call(arguments,0):[],n=null,r=null,e=null,o=0,i=t.length;i>o;o++)s=t[o],"success"===s||"timeout"===s||"abort"===s?n=s:null!=(null!=s?s.readyState:void 0)&&null!=(null!=s?s.responseText:void 0)?r=s:_.isObject(s)&&(e=s);return[n,e,r]},t.prototype["do"]=function(){var s,t,n,r,o,i,a,h,c,p,d,g=this;for(r=arguments[0],i=arguments[1],s=arguments.length>=3?l.call(arguments,2):[],null==i&&(i={}),r=e.extend(!0,{},this.messageDefaults,this.doDefaults,null!=r?r:{}),n=this._parseEvents(r.events),o=null!=(p=r.messageInstance)?p:this.newMessage(r),null!=r.id&&(o.options.id=r.id),null!=r.progressMessage&&o.update(e.extend({},r,{message:r.progressMessage,type:"info"})),_.each(["error","success"],function(t){var a,h;return a=null!=(h=i[t])?h:function(){},i[t]=function(){var h,c,p,d,m,f,y,v,_,C,w,b,$;return f=arguments.length>=1?l.call(arguments,0):[],v=g._normalizeResponse.apply(g,f),m=v[0],h=v[1],y=v[2],"success"===t&&null==o.errorCount&&r.showSuccessWithoutError===!1&&(r.successMessage=null),"error"===t&&(null==(_=r.errorCount)&&(r.errorCount=0),r.errorCount+=1),p=g._getMessage(d=a.apply(null,f),r[t+"Message"]),"error"!==t||0!==(null!=y?y.status:void 0)&&"abort"!==m?"error"===t&&null!=r.ignoredErrorCodes&&(C=null!=y?y.status:void 0,u.call(r.ignoredErrorCodes,C)>=0)?(o.hide(),void 0):p?(c=e.extend({},r,{message:p,type:t,events:null!=(w=n[t])?w:{},hideOnNavigate:"success"===t}),"error"===t&&(null!=y?y.status:void 0)>=500?(null!=(b=c.retry)?b.allow:void 0)&&(null==c.retry.delay&&(c.retry.delay=4>c.errorCount?10:300),c.hideAfter&&(null==($=c._hideAfter)&&(c._hideAfter=c.hideAfter),c.hideAfter=c._hideAfter+c.retry.delay),c._retryActions=!0,c.actions={retry:{label:"retry now",phrase:"Retrying TIME",auto:c.retry.auto,delay:c.retry.delay,action:function(){return c.messageInstance=o,g["do"].apply(g,[c,i].concat(l.call(s)))}},cancel:{action:function(){return o.cancel()}}}):c._retryActions&&(delete r.actions.retry,delete r.actions.cancel,delete r._retryActions),e.globalMessenger(),o.update(c),o.show()):o.hide():(o.hide(),void 0)}}),o._actionInstance=r.action.apply(r,[i].concat(l.call(s))),a=["done","progress","fail","state","then"],h=0,c=a.length;c>h;h++)t=a[h],null!=o[t]&&delete o[t],o[t]=null!=(d=o._actionInstance)?d[t]:void 0;return o},t}(r),e.fn.messenger=function(){var t,n,r,o,i,a;return r=arguments[0],n=arguments.length>=2?l.call(arguments,1):[],null==r&&(r={}),t=this,null!=r&&_.isString(r)?(a=t.data("messenger"))[r].apply(a,n):(i=r,null==t.data("messenger")&&(t.data("messenger",o=new s(e.extend({el:t},i))),o.render()),t.data("messenger"))},e.globalMessenger=function(s){var t,n,r,o,i,a,l,u,h,c,p;if(a={extraClasses:"messenger-fixed messenger-on-bottom messenger-on-right messenger-theme-future",maxMessages:9,parentLocations:["body"]},s=e.extend(a,e._messengerDefaults,s),l=s.instance||e._messengerInstance,null==s.instance){for(h=s.parentLocations,n=null,r=null,c=0,p=h.length;p>c;c++)if(u=h[c],n=e(u),n.length){o=u;break}l?e(l._location)!==e(o)&&(l.$el.detach(),n.prepend(l.$el)):(t=e("<ul>"),n.prepend(t),l=t.messenger(s),l._location=o,e._messengerInstance=l)}return null!=l._addedClasses&&l.$el.removeClass(l._addedClasses),l.$el.addClass(i=""+l.className+" "+s.extraClasses),l._addedClasses=i,l}}).call(this);