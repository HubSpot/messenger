/*! messenger 1.1.3 2013-03-04 */
(function(){var e,t,s,n,r,o,i={}.hasOwnProperty,a=function(e,t){function s(){this.constructor=e}for(var n in t)i.call(t,n)&&(e[n]=t[n]);return s.prototype=t.prototype,e.prototype=new s,e.__super__=t.prototype,e},l=[].slice,u=[].indexOf||function(e){for(var t=0,s=this.length;s>t;t++)if(t in this&&this[t]===e)return t;return-1};e=jQuery,o='<div class="messenger-spinner">\n    <span class="messenger-spinner-side messenger-spinner-side-left">\n        <span class="messenger-spinner-fill"></span>\n    </span>\n    <span class="messenger-spinner-side messenger-spinner-side-right">\n        <span class="messenger-spinner-fill"></span>\n    </span>\n</div>',n=function(t){function s(){return s.__super__.constructor.apply(this,arguments)}return a(s,t),s.prototype.defaults={hideAfter:10,scroll:!0},s.prototype.initialize=function(t){return null==t&&(t={}),this.shown=!1,this.rendered=!1,this.messenger=t.messenger,this.options=e.extend({},this.options,t,this.defaults)},s.prototype.show=function(){var e;return this.render(),this.$message.removeClass("messenger-hidden"),e=this.shown,this.shown=!0,e?void 0:this.trigger("show")},s.prototype.hide=function(){var e;if(this.rendered)return this.$message.addClass("messenger-hidden"),e=this.shown,this.shown=!1,e?this.trigger("hide"):void 0},s.prototype.cancel=function(){return this.hide()},s.prototype.update=function(t){var s,n=this;return e.extend(this.options,t),this.lastUpdate=new Date,this.rendered=!1,this.events=null!=(s=this.options.events)?s:{},this.render(),this.actionsToEvents(),this.delegateEvents(),this.checkClickable(),this.options.hideAfter?(this.$message.addClass("messenger-will-hide-after"),null!=this._hideTimeout&&clearTimeout(this._hideTimeout),this._hideTimeout=setTimeout(function(){return n.hide()},1e3*this.options.hideAfter)):this.$message.removeClass("messenger-will-hide-after"),this.options.hideOnNavigate?(this.$message.addClass("messenger-will-hide-on-navigate"),null!=Backbone.history&&Backbone.history.on("route",function(){return n.hide()})):this.$message.removeClass("messenger-will-hide-on-navigate"),this.trigger("update",this)},s.prototype.scrollTo=function(){return this.options.scroll?e.scrollTo(this.$el,{duration:400,offset:{left:0,top:-20}}):void 0},s.prototype.timeSinceUpdate=function(){return this.lastUpdate?new Date-this.lastUpdate:null},s.prototype.actionsToEvents=function(){var e,t,s,n;s=this.options.actions,n=[];for(t in s)e=s[t],n.push(this.events['click [data-action="'+t+'"] a']=function(e){return function(t){return t.preventDefault(),t.stopPropagation(),e.action(t)}}(e));return n},s.prototype.checkClickable=function(){var e,t,s,n;s=this.events,n=[];for(t in s)e=s[t],"click"===t?n.push(this.$message.addClass("messenger-clickable")):n.push(void 0);return n},s.prototype.undelegateEvents=function(){var e;return s.__super__.undelegateEvents.apply(this,arguments),null!=(e=this.$message)?e.removeClass("messenger-clickable"):void 0},s.prototype.parseActions=function(){var t,s,n,r,o,i;s=[],o=this.options.actions;for(r in o)t=o[r],n=e.extend({},t),n.name=r,null==(i=n.label)&&(n.label=r),s.push(n);return s},s.prototype.template=function(t){var s,n,r,i,a,l,u,c,h,p,d=this;for(a=e("<div class='messenger-message message alert "+t.type+" message-"+t.type+" alert-"+t.type+"'>"),t.showCloseButton&&(r=e('<button type="button" class="close" data-dismiss="alert">&times;</button>'),r.click(function(){return d.cancel(),!0}),a.append(r)),l=e('<div class="messenger-message-inner">'+t.message+"</div>"),a.append(l),a.append(e(o)),t.actions.length&&(n=e('<div class="messenger-actions">')),p=t.actions,c=0,h=p.length;h>c;c++)u=p[c],s=e("<span>"),s.attr("data-action",""+u.name),i=e("<a>"),i.html(u.label),s.append(e('<span class="messenger-phrase">')),s.append(i),n.append(s);return a.append(n),a},s.prototype.render=function(){var t;if(!this.rendered)return this._hasSlot||(this.setElement(this.messenger._reserveMessageSlot(this)),this._hasSlot=!0),t=e.extend({},this.options,{actions:this.parseActions()}),this.$message=e(this.template(t)),this.$el.html(this.$message),this.shown=!0,this.rendered=!0,this.trigger("render")},s}(Backbone.View),s=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return a(t,e),t.prototype.initialize=function(){return t.__super__.initialize.apply(this,arguments),this._timers={}},t.prototype.cancel=function(){return this.clearTimers(),this.hide(),null!=this._actionInstance&&null!=this._actionInstance.abort?this._actionInstance.abort():void 0},t.prototype.clearTimers=function(){var e,t,s,n;s=this._timers;for(e in s)t=s[e],clearTimeout(t);return null!=(n=this.$message)?n.removeClass("messenger-retry-soon messenger-retry-later"):void 0},t.prototype.render=function(){var e,s,n,r;t.__super__.render.apply(this,arguments),this.clearTimers(),n=this.options.actions,r=[];for(s in n)e=n[s],e.auto?r.push(this.startCountdown(s,e)):r.push(void 0);return r},t.prototype.renderPhrase=function(e,t){var s;return s=e.phrase.replace("TIME",this.formatTime(t))},t.prototype.formatTime=function(e){var t;return t=function(e,t){return e=Math.floor(e),1!==e&&(t+="s"),"in "+e+" "+t},0===Math.floor(e)?"now...":60>e?t(e,"second"):(e/=60,60>e?t(e,"minute"):(e/=60,t(e,"hour")))},t.prototype.startCountdown=function(e,t){var s,n,r,o,i=this;return s=this.$message.find("[data-action='"+e+"'] .messenger-phrase"),n=null!=(o=t.delay)?o:3,10>=n?(this.$message.removeClass("messenger-retry-later"),this.$message.addClass("messenger-retry-soon")):(this.$message.removeClass("messenger-retry-soon"),this.$message.addClass("messenger-retry-later")),r=function(){return n-=1,s.text(i.renderPhrase(t,n)),n>0?i._timers[e]=setTimeout(r,1e3):(i.$message.removeClass("messenger-retry-soon messenger-retry-later"),delete i._timers[e],t.action())},r()},t}(n),r=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return a(n,t),n.prototype.tagName="ul",n.prototype.className="messenger",n.prototype.messageDefaults={type:"info"},n.prototype.initialize=function(t){return this.options=null!=t?t:{},this.history=[],this.messageDefaults=e.extend({},this.messageDefaults,this.options.messageDefaults)},n.prototype.render=function(){return this.updateMessageSlotClasses()},n.prototype.findById=function(e){return _.filter(this.history,function(t){return t.msg.options.id===e})},n.prototype._reserveMessageSlot=function(t){var s,n,r=this;for(s=e("<li>"),s.addClass("messenger-message-slot"),this.$el.prepend(s),this.history.push({msg:t,$slot:s}),this._enforceIdConstraint(t),t.on("update",function(){return r._enforceIdConstraint(t)});this.options.maxMessages&&this.history.length>this.options.maxMessages;)n=this.history.shift(),n.msg.remove(),n.$slot.remove();return s},n.prototype._enforceIdConstraint=function(e){var t,s,n,r,o;if(null!=e.options.id)for(o=this.history,s=0,n=o.length;n>s;s++)if(t=o[s],r=t.msg,null!=r.options.id&&r.options.id===e.options.id&&e!==r){if(e.options.singleton)return e.hide(),void 0;r.hide()}},n.prototype.newMessage=function(e){var t,n=this;return null==e&&(e={}),e.messenger=this,t=new s(e),t.on("show",function(){return e.scrollTo&&"fixed"!==n.$el.css("position")?t.scrollTo():void 0}),t.on("hide show render",this.updateMessageSlotClasses,this),t},n.prototype.updateMessageSlotClasses=function(){var e,t,s,n,r,o,i;for(n=!0,t=null,e=!1,i=this.history,r=0,o=i.length;o>r;r++)s=i[r],s.$slot.removeClass("first last shown"),s.msg.shown&&s.msg.rendered&&(s.$slot.addClass("shown"),e=!0,t=s,n&&(n=!1,s.$slot.addClass("first")));return null!=t&&t.$slot.addClass("last"),this.$el[""+(e?"remove":"add")+"Class"]("messenger-empty")},n.prototype.hideAll=function(){var e,t,s,n,r;for(n=this.history,r=[],t=0,s=n.length;s>t;t++)e=n[t],r.push(e.msg.hide());return r},n.prototype.post=function(t){var s;return _.isString(t)&&(t={message:t}),t=e.extend(!0,{},this.messageDefaults,t),s=this.newMessage(t),s.update(t),s},n}(Backbone.View),t=function(t){function s(){return s.__super__.constructor.apply(this,arguments)}return a(s,t),s.prototype.doDefaults={progressMessage:null,successMessage:null,errorMessage:"Error connecting to the server.",showSuccessWithoutError:!0,retry:{auto:!0,allow:!0},action:e.ajax},s.prototype.hookBackboneAjax=function(t){var s,n=this;return null==t&&(t={}),t=_.defaults(t,{id:"BACKBONE_ACTION",errorMessage:!1,successMessage:"Request completed successfully.",showSuccessWithoutError:!1}),s=function(e){var s;return s=_.extend({},t,e.messenger),n["do"](s,e)},null!=Backbone.ajax?(Backbone.ajax._withoutMessenger&&(Backbone.ajax=Backbone.ajax._withoutMessenger),(null==t.action||t.action===this.doDefaults.action)&&(t.action=Backbone.ajax),s._withoutMessenger=Backbone.ajax,Backbone.ajax=s):Backbone.sync=_.wrap(Backbone.sync,function(){var t,n,r;return r=arguments[0],t=arguments.length>=2?l.call(arguments,1):[],n=e.ajax,e.ajax=s,r.call.apply(r,[this].concat(l.call(t))),e.ajax=n})},s.prototype._getMessage=function(e,t){return e===!1?!1:e===!0||null==e||"string"!=typeof e?t:e},s.prototype._parseEvents=function(e){var t,s,n,r,o,i,a;null==e&&(e={}),o={};for(r in e)n=e[r],s=r.indexOf(" "),i=r.substring(0,s),t=r.substring(s+1),null==(a=o[i])&&(o[i]={}),o[i][t]=n;return o},s.prototype._normalizeResponse=function(){var e,t,s,n,r,o,i;for(s=arguments.length>=1?l.call(arguments,0):[],n=null,r=null,e=null,o=0,i=s.length;i>o;o++)t=s[o],"success"===t||"timeout"===t||"abort"===t?n=t:null!=(null!=t?t.readyState:void 0)&&null!=(null!=t?t.responseText:void 0)?r=t:_.isObject(t)&&(e=t);return[n,e,r]},s.prototype["do"]=function(){var t,s,n,r,o,i,a,c,h,p,d,g=this;for(r=arguments[0],i=arguments[1],t=arguments.length>=3?l.call(arguments,2):[],null==i&&(i={}),r=e.extend(!0,{},this.messageDefaults,this.doDefaults,null!=r?r:{}),n=this._parseEvents(r.events),o=null!=(p=r.messageInstance)?p:this.newMessage(r),null!=r.id&&(o.options.id=r.id),null!=r.progressMessage&&o.update(e.extend({},r,{message:r.progressMessage,type:"info"})),_.each(["error","success"],function(s){var a,c;return a=null!=(c=i[s])?c:function(){},i[s]=function(){var c,h,p,d,m,f,y,v,_,C,w,b,x;return f=arguments.length>=1?l.call(arguments,0):[],v=g._normalizeResponse.apply(g,f),m=v[0],c=v[1],y=v[2],"success"===s&&null==o.errorCount&&r.showSuccessWithoutError===!1&&(r.successMessage=null),"error"===s&&(null==(_=r.errorCount)&&(r.errorCount=0),r.errorCount+=1),p=g._getMessage(d=a.apply(null,f),r[s+"Message"]),"error"!==s||0!==(null!=y?y.status:void 0)&&"abort"!==m?"error"===s&&null!=r.ignoredErrorCodes&&(C=null!=y?y.status:void 0,u.call(r.ignoredErrorCodes,C)>=0)?(o.hide(),void 0):p?(h=e.extend({},r,{message:p,type:s,events:null!=(w=n[s])?w:{},hideOnNavigate:"success"===s}),"error"===s&&(null!=y?y.status:void 0)>=500?(null!=(b=h.retry)?b.allow:void 0)&&(null==h.retry.delay&&(h.retry.delay=4>h.errorCount?10:300),h.hideAfter&&(null==(x=h._hideAfter)&&(h._hideAfter=h.hideAfter),h.hideAfter=h._hideAfter+h.retry.delay),h._retryActions=!0,h.actions={retry:{label:"retry now",phrase:"Retrying TIME",auto:h.retry.auto,delay:h.retry.delay,action:function(){return h.messageInstance=o,g["do"].apply(g,[h,i].concat(l.call(t)))}},cancel:{action:function(){return o.cancel()}}}):h._retryActions&&(delete r.actions.retry,delete r.actions.cancel,delete r._retryActions),e.globalMessenger(),o.update(h),o.show()):o.hide():(o.hide(),void 0)}}),o._actionInstance=r.action.apply(r,[i].concat(l.call(t))),a=["done","progress","fail","state","then"],c=0,h=a.length;h>c;c++)s=a[c],null!=o[s]&&delete o[s],o[s]=null!=(d=o._actionInstance)?d[s]:void 0;return o},s}(r),e.fn.messenger=function(){var s,n,r,o,i,a;return r=arguments[0],n=arguments.length>=2?l.call(arguments,1):[],null==r&&(r={}),s=this,null!=r&&_.isString(r)?(a=s.data("messenger"))[r].apply(a,n):(i=r,null==s.data("messenger")&&(s.data("messenger",o=new t(e.extend({el:s},i))),o.render()),s.data("messenger"))},e.globalMessenger=function(t){var s,n,r,o,i,a,l,u,c,h,p;if(a={extraClasses:"messenger-fixed messenger-on-bottom messenger-on-right messenger-theme-future",maxMessages:9,parentLocations:["body"]},t=e.extend(a,e._messengerDefaults,t),l=t.instance||e._messengerInstance,null==t.instance){for(c=t.parentLocations,n=null,r=null,h=0,p=c.length;p>h;h++)if(u=c[h],n=e(u),n.length){o=u;break}l?e(l._location)!==e(o)&&(l.$el.detach(),n.prepend(l.$el)):(s=e("<ul>"),n.prepend(s),l=s.messenger(t),l._location=o,e._messengerInstance=l)}return null!=l._addedClasses&&l.$el.removeClass(l._addedClasses),l.$el.addClass(i=""+l.className+" "+t.extraClasses),l._addedClasses=i,l}}).call(this);